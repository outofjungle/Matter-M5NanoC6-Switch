services:
  esp-idf:
    # Build custom image based on ESP-Matter with additional dependencies
    # Base: espressif/esp-matter:release-v1.5_idf_v5.4.1
    build:
      context: .
      dockerfile: Dockerfile
    image: m5nanoc6-switch:latest

    volumes:
      # Mount project source code (includes build directory)
      - .:/project

    working_dir: /project

    environment:
      # Target chip
      - IDF_TARGET=esp32c6
      # ESP-Matter SDK path (in official Docker image)
      - ESP_MATTER_PATH=/opt/espressif/esp-matter
      # Git safe directory (prevents git ownership warnings)
      - IDF_GIT_SAFE_DIR=/project

    # Device pass-through for flashing and monitoring
    # NOTE: Docker for Mac does NOT support USB device pass-through
    # Use RFC2217 remote serial port instead (see docs/IDF-DOCKER-MAC.md)
    #
    # On Linux, you can use direct device pass-through:
    # devices:
    #   - /dev/ttyUSB0:/dev/ttyUSB0
    #
    # On macOS, use RFC2217:
    # 1. Run: ./scripts/ser2net-start.sh (on host)
    # 2. Use: -p rfc2217://host.docker.internal:4000 with idf.py commands

    stdin_open: true
    tty: true
